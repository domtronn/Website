function Point(a,b){this.x=a,this.y=b,this.px=a,this.py=b,this.pinned=!1,this.pin_x=null,this.pin_y=null,this.constraints=[]}function Vector(a){this.vertices=a,this.x=a[0].x-a[1].x,this.y=a[0].y-a[1].y,this.length=this.calculateLength(a)}function darken(a,b){var c=parseInt(a.slice(1),16),d=Math.round(2.55*b),e=(c>>16)+d,f=(c>>8&255)+d,g=(255&c)+d;return"#"+(16777216+65536*(255>e?1>e?0:e:255)+256*(255>f?1>f?0:f:255)+(255>g?1>g?0:g:255)).toString(16).slice(1)}function renderSquare(a){var b=points.indexOf(a)+1,c=Math.floor(b/cloth.width),d=b-c*cloth.width;if(d%cloth.width&&c!==cloth.height-1){var e=points[(c+1)*cloth.width-1+d],f=points[c*cloth.width+d],g=points[(c+1)*cloth.width+d],h=(spacing.i*spacing.j,Math.abs((a.x-e.x)*(g.y-e.y)-(a.y-e.y)*(g.x-e.x)),Math.abs(new Vector([a,e]).dot(new Vector([a,f]))));ctx.beginPath(),ctx.moveTo(a.x,a.y),ctx.lineTo(e.x,e.y),ctx.lineTo(g.x,g.y),ctx.lineTo(f.x,f.y),ctx.closePath(),ctx.strokeStyle=ctx.fillStyle=darken(renderSquare.prototype.COLOUR,30-30*h),ctx.fill(),ctx.stroke()}}function toggleControls(){controls.className.indexOf("slideLeft")<0?(controls.classList.add("slideLeft"),controls.classList.add("rotateRight")):(controls.classList.remove("slideLeft"),controls.classList.remove("rotateRight"))}var Constraint=function(a,b){this.a=a,this.b=b,this.length=Math.sqrt(Math.pow(this.a.x-this.b.x,2)+Math.pow(this.a.y-this.b.y,2))};Constraint.prototype.draw=function(){ctx.beginPath(),ctx.moveTo(this.a.x,this.a.y),ctx.lineTo(this.b.x,this.b.y),ctx.stroke()},Constraint.prototype.resolve=function(){var a=this.a.x-this.b.x,b=this.a.y-this.b.y,c=Math.sqrt(a*a+b*b),d=(this.length-c)/c,e=a*d*.5,f=b*d*.5;this.a.x+=e,this.a.y+=f,this.b.x-=e,this.b.y-=f},Point.prototype.draw=function(){this.constraints.forEach(function(a){a.draw()}),ctx.beginPath();var a=2;return this.pinned?(ctx.fillStyle="#212121",a=5):ctx.fillStyle="red",ctx.fill(),this},Point.prototype.pin=function(){return this.pinned=!0,this.pin_x=this.x,this.pin_y=this.y,this},Point.prototype.unpin=function(){return this.pinned=!1,this},Point.prototype.attach=function(a){this.constraints.push(new Constraint(this,a))},Point.prototype.resolve_constraints=function(){this.pinned&&(this.x=this.pin_x),this.pinned&&(this.y=this.pin_y);this.constraints.forEach(function(a){a.resolve()})},Point.prototype.step=function(a){var b,c,d=a*a,e={x:0,y:70};b=this.x+(this.x-this.px)+e.x*d,c=this.y+(this.y-this.py)+e.y*d,this.px=this.x,this.py=this.y,this.x=b,this.y=c},Vector.prototype.vertex=function(a){return this.vertices[a]},Vector.prototype.calculateLength=function(a){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))},Vector.prototype.dot=function(a){return(this.x*a.x+this.y*a.y)/(this.length*a.length)};var canvas,ctx,width,height,points,spacing,cloth,start_x,start_y;window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}(),canvas=document.getElementById("canvas"),ctx=canvas.getContext("2d"),width=ctx.canvas.width=window.innerWidth,height=ctx.canvas.height=window.innerHeight,points=[],spacing={i:50,j:50},cloth={width:11,height:8},start_x=width/2-cloth.width*spacing.i/2,start_y=60;var j=0,jMax=cloth.height;for(j;jMax>j;j++){var i=0,iMax=cloth.width;for(i;iMax>i;i++){var p=new Point(start_x+i*spacing.i,start_y+j*spacing.j);0!==i&&p.attach(points[points.length-1]),0!==j&&p.attach(points[(j-1)*cloth.width+i]),0===j&&i%Math.floor(cloth.width/2)===0&&p.pin(),points.push(p)}}renderSquare.prototype.COLOUR="#9862a4";var mouse={nearestPoint:null};canvas.onmousedown=function(a){var b,c,d,e=1e5;b=new Point(a.offsetX,a.offsetY),e=new Vector([points[0],b]).length,points.forEach(function(a){c=new Vector([a,b]).length,e>c&&(e=c,d=a)}),mouse.nearestPoint=d},canvas.onmouseup=function(a){mouse.nearestPoint=null},canvas.onmousemove=function(a){mouse.nearestPoint&&(mouse.nearestPoint.x=a.x,mouse.nearestPoint.y=a.y),a.preventDefault()},function a(){ctx.clearRect(0,0,canvas.width,canvas.height),ctx.lineWidth=1,points.forEach(function(a){for(var b=3;b--;)a.resolve_constraints();a.step(.028)}),points.forEach(function(a){a.draw()}),requestAnimFrame(a)}();var controls=document.getElementById("controls");document.getElementById("control-nav").onclick=function(){toggleControls()},document.addEventListener("keydown",function(a){67===a.keyCode&&toggleControls()});