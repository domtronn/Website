function darken(a,b){var c=parseInt(a.slice(1),16),d=Math.round(2.55*b),e=(c>>16)+d,f=(c>>8&255)+d,g=(255&c)+d;return"#"+(16777216+65536*(255>e?1>e?0:e:255)+256*(255>f?1>f?0:f:255)+(255>g?1>g?0:g:255)).toString(16).slice(1)}function rgb2hex(a,b,c){return"#"+byte2Hex(a)+byte2Hex(b)+byte2Hex(c)}function byte2Hex(a){var b="0123456789ABCDEF";return String(b.substr(a>>4&15,1))+b.substr(15&a,1)}function Constraint(a,b){this.p1=a,this.p2=b,this.length=this.p1.getCurrent().minus(this.p2.getCurrent()).length()}function Point(a,b){this.current=new Vector(a,b),this.previous=new Vector(a,b),this.pinned=!1,this.acc=new Vector(0,.5).scale(.1)}function Vector(a,b){this.x=a,this.y=b}function toggleColourful(){Cloth.prototype.RENDER=!Cloth.prototype.RENDER}function toggleConstraints(){Cloth.prototype.DRAW_CONSTRAINTS=!Cloth.prototype.DRAW_CONSTRAINTS}function togglePoints(){Cloth.prototype.DRAW_POINTS=!Cloth.prototype.DRAW_POINTS}function toggleRainbow(){Cloth.prototype.RAINBOW=!Cloth.prototype.RAINBOW}function setColor(a){Cloth.prototype.COLOUR="#"+a.toString()}function setFPSCounter(a){var b=document.getElementById("fps-counter");b.textContent=a}function toggleControls(){controls.className.indexOf("slideLeft")<0?(controls.classList.add("slideLeft"),controls.classList.add("rotateRight")):(controls.classList.remove("slideLeft"),controls.classList.remove("rotateRight"))}var Cloth=function(){this.points=[],this.constraints=[];for(var a=ctx.canvas.width/2-this.WIDTH*this.SPACING/2,b=60,c=0,d=b;c<this.HEIGHT;c++,d+=this.SPACING)for(var e=0,f=a;e<this.WIDTH;e++,f+=this.SPACING){var g=new Point(f,d+(this.WIDTH/2-Math.abs(e-this.WIDTH/2))*this.OFFSET);0!==e&&this.constraints.push(new Constraint(g,this.points[this.points.length-1])),0!==c&&this.constraints.push(new Constraint(g,this.points[(c-1)*this.WIDTH+e])),0!==c||0!==e&&e!==this.WIDTH-1||g.pin(),0===c&&e%Math.floor(this.PIN_WIDTH)===0&&g.pin(),this.points.push(g)}};Cloth.prototype.renderSquare=function(a){var b=this.points.indexOf(a)+1,c=Math.floor(b/this.WIDTH),d=b-c*this.WIDTH;if(d%this.WIDTH&&c!==this.HEIGHT-1){var e=a.getCurrent(),f=this.points[(c+1)*this.WIDTH-1+d].getCurrent(),g=this.points[c*this.WIDTH+d].getCurrent(),h=this.points[(c+1)*this.WIDTH+d].getCurrent(),i=Math.abs(e.minus(f).dot(e.minus(g)));ctx.beginPath(),ctx.moveTo(e.x,e.y),ctx.lineTo(f.x,f.y),ctx.lineTo(h.x,h.y),ctx.lineTo(g.x,g.y),ctx.closePath();var j=this.RAINBOW?rgb2hex(127*Math.sin(.3*d+0)+128,127*Math.sin(.3*d+2)+128,127*Math.sin(.3*d+4)+128):this.COLOUR;ctx.strokeStyle=ctx.fillStyle=darken(j,30-30*i),ctx.fill(),ctx.stroke()}},Cloth.prototype.getClosestPoint=function(a){var b,c,d=1e5;return this.points.forEach(function(e){b=a.minus(e.getCurrent()).length(),d>b&&(d=b,c=e)}),c},Cloth.prototype.update=function(){this.points.forEach(function(a){a.move()});var a=this.ITERATIONS;for(a;a--;)this.constraints.forEach(function(a){a.resolve()});this.render()},Cloth.prototype.render=function(){var a=this;this.RENDER&&this.points.forEach(function(b){a.renderSquare(b)}),this.DRAW_POINTS&&this.points.forEach(function(a){a.draw()}),this.DRAW_CONSTRAINTS&&this.constraints.forEach(function(a){a.draw()})},Cloth.prototype.WIDTH=30,Cloth.prototype.HEIGHT=30,Cloth.prototype.SPACING=20,Cloth.prototype.PIN_WIDTH=10,Cloth.prototype.OFFSET=1,Cloth.prototype.ITERATIONS=2,Cloth.prototype.DRAW_POINTS=!1,Cloth.prototype.DRAW_CONSTRAINTS=!0,Cloth.prototype.RENDER=!0,Cloth.prototype.RAINBOW=!1,Cloth.prototype.COLOUR="#9862a4",Constraint.prototype={resolve:function(){var a=this.p1.getCurrent(),b=this.p2.getCurrent(),c=b.minus(a),d=c.length(),e=(d-this.length)/(2*(this.length+d)),f=c.scale(.5*e);this.p1.pinned||this.p1.setCurrent(a.add(f)),this.p2.pinned||this.p2.setCurrent(b.minus(f))},draw:function(){ctx.beginPath(),ctx.strokeStyle="black",ctx.moveTo(this.p1.getCurrent().x,this.p1.getCurrent().y),ctx.lineTo(this.p2.getCurrent().x,this.p2.getCurrent().y),ctx.stroke()}},Point.prototype={getCurrent:function(){return this.current},setCurrent:function(a){this.current=a},getPrevious:function(){return this.previous},setPrevious:function(a){this.previous=a},pin:function(){this.pinned=!0},move:function(){if(!this.pinned){var a=this.current.scale(1.99).minus(this.previous.scale(.99)).add(this.acc);this.setPrevious(this.current),this.setCurrent(a)}},draw:function(){ctx.beginPath(),ctx.fillStyle="black",ctx.arc(this.current.x,this.current.y,2,0,2*Math.PI),ctx.fill(),ctx.stroke()}},Vector.prototype={add:function(a){var b=this.x+a.x,c=this.y+a.y;return new Vector(b,c)},minus:function(a){var b=this.x-a.x,c=this.y-a.y;return new Vector(b,c)},scale:function(a){var b=this.x*a,c=this.y*a;return new Vector(b,c)},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},dot:function(a){return(this.x*a.x+this.y*a.y)/(this.length()*a.length())}};var canvas,ctx,cloth,lastCallTime,fps;window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}(),canvas=document.getElementById("canvas"),ctx=canvas.getContext("2d"),ctx.canvas.width=window.innerWidth,ctx.canvas.height=window.innerHeight,cloth=new Cloth;var mouse={minPoint:null};canvas.onmousedown=function(a){mouse.minPoint=cloth.getClosestPoint(new Vector(a.offsetX,a.offsetY))},canvas.onmouseup=function(a){mouse.minPoint=null},canvas.onmousemove=function(a){mouse.minPoint&&mouse.minPoint.setCurrent(new Vector(a.offsetX,a.offsetY)),a.preventDefault()};var s1=new Slider("#width",{min:1,max:80,step:4,value:Cloth.prototype.WIDTH});s1.on("change",function(a){Cloth.prototype.WIDTH=a.newValue,cloth=new Cloth});var s2=new Slider("#height",{min:1,max:80,step:1,value:Cloth.prototype.HEIGHT});s2.on("change",function(a){Cloth.prototype.HEIGHT=a.newValue,cloth=new Cloth});var s3=new Slider("#spacing",{min:1,max:60,step:1,value:Cloth.prototype.SPACING});s3.on("change",function(a){Cloth.prototype.SPACING=a.newValue,cloth=new Cloth});var s4=new Slider("#pinwidth",{min:1,max:10,step:1,value:Cloth.prototype.PIN_WIDTH});s4.on("change",function(a){Cloth.prototype.PIN_WIDTH=a.newValue,cloth=new Cloth});var s5=new Slider("#offset",{min:0,max:3,step:.05,value:Cloth.prototype.OFFSET});s5.on("change",function(a){Cloth.prototype.OFFSET=a.newValue,cloth=new Cloth}),document.addEventListener("keydown",function(a){67===a.keyCode&&(document.getElementById("color-picker").color.hidePicker(),document.getElementById("canvas").focus())}),function a(){lastCallTime||(lastCallTime=Date.now(),fps=0),ctx.clearRect(0,0,canvas.width,canvas.height),ctx.lineWidth=1,cloth.update(),fps=1e3/((new Date).getTime()-lastCallTime),lastCallTime=Date.now(),setFPSCounter(fps.toPrecision(4)),requestAnimFrame(a)}();var controls=document.getElementById("controls");document.getElementById("control-nav").onclick=function(){toggleControls()},document.addEventListener("keydown",function(a){67===a.keyCode&&toggleControls()});